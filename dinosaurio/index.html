<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dinosaur Canvas Game</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body { 
            background: #e0f7fa; 
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 80px;
            height: auto;
            min-height: 180px;
            background: #b2dfdb;
            box-shadow: 2px 0 8px #0002;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px;
            padding-bottom: 30px;
            justify-content: center;
        }
        .sidebar h2 {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        .sidebar button {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 6px;
            background: #4caf50;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar button:hover {
            background: #388e3c;
        }
        .sidebar-items {
            margin-top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 10px;
        }
        .sidebar-item {
            width: 100%;
            padding: 10px 0;
            text-align: center;
            font-size: 1.5em;
            cursor: grab;
            user-select: none;
            transition: background 0.2s;
        }
        .sidebar-item:hover {
            background: #4caf50;
            color: #fff;
        }
        canvas { 
            display: block; 
            margin: 0; 
            background: #a7ffeb; 
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }
    </style>
</head>
<body>

<button id="startGameBtn" style="
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 200;
    font-size: 2em;
    padding: 24px 48px;
    background: linear-gradient(90deg, #ffb300, #ff7043);
    color: #fff;
    border: none;
    border-radius: 18px;
    box-shadow: 0 4px 24px #0003;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
">Comenzar</button>

<div class="sidebar">
    <div class="sidebar-items">
        <div draggable="true" class="sidebar-item" data-type="health" title="Heal">
            <span style="font-size:22px; color:#e53935;">‚ù§</span>
        </div>
        <div draggable="true" class="sidebar-item" data-type="meat" title="Feed Meat">
            <span style="font-size:22px;">üçñ</span>
        </div>
        <div draggable="true" class="sidebar-item" data-type="veggie" title="Feed Veggie">
            <span style="font-size:22px;">ü•¶</span>
        </div>
        <div draggable="true" class="sidebar-item" data-type="hygene" title="Clean">
            <span style="font-size:22px;">üßº</span>
        </div>
    </div>
</div>
<canvas id="gameCanvas"></canvas>
<script>
let eggs = [];
const eggIcon = 'ü•ö';
const eggSize = 32;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Resize canvas to fill window
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    draw();
}
window.addEventListener('resize', resizeCanvas);

// Dinosaur image URLs (OpenMoji PNGs)
const dinoImages = [
    "images/sauropod.png", // Sauropod
    "images/trex.png"  // T-Rex
];

// Dinosaur class: add a type property (0 = sauropod, 1 = trex)
class Dinosaur {
    constructor(x, y, imgUrl, type) {
        this.x = x;
        this.y = y;
        this.size = 100;
        this.img = new Image();
        this.img.src = imgUrl;
        this.selected = false;
        this.type = type; // 0 = sauropod, 1 = trex
        // Add stats
        this.health = 100;
        this.hunger = 100;
        this.hygene = 100;
        // Randomly face left or right
        this.facing = Math.random() < 0.5 ? 'left' : 'right';
    }

    draw(ctx) {
        ctx.save();
        if (this.facing === 'left') {
            ctx.translate(this.x + this.size, this.y);
            ctx.scale(-1, 1);
            ctx.drawImage(this.img, 0, 0, this.size, this.size);
        } else {
            ctx.drawImage(this.img, this.x, this.y, this.size, this.size);
        }
        ctx.restore();
        // Draw stats bars below the dinosaur ONLY if selected
        if (this.selected) {
            const barWidth = this.size;
            const barHeight = 7;
            const spacing = 3;
            const iconSize = 10; // Match bar height
            const iconOffset = 4;
            const startY = this.y + this.size + 5;
            // Health (red)
            ctx.save();
            ctx.fillStyle = '#e53935';
            ctx.fillRect(
                this.x + iconSize + iconOffset,
                startY,
                (barWidth - iconSize - iconOffset) * (this.health / 100),
                barHeight
            );
            ctx.strokeStyle = '#b71c1c';
            ctx.strokeRect(this.x + iconSize + iconOffset, startY, barWidth - iconSize - iconOffset, barHeight);
            ctx.font = `bold ${iconSize}px sans-serif`;
            ctx.textBaseline = 'top';
            ctx.fillText('‚ù§', this.x, startY - 1);
            ctx.restore();
            // Hunger (yellow)
            ctx.save();
            ctx.fillStyle = '#fbc02d';
            ctx.fillRect(
                this.x + iconSize + iconOffset,
                startY + barHeight + spacing,
                (barWidth - iconSize - iconOffset) * (this.hunger / 100),
                barHeight
            );
            ctx.strokeStyle = '#f57c00';
            ctx.strokeRect(this.x + iconSize + iconOffset, startY + barHeight + spacing, barWidth - iconSize - iconOffset, barHeight);
            ctx.font = `bold ${iconSize}px sans-serif`;
            ctx.textBaseline = 'top';
            ctx.fillText('üçñ', this.x, startY + barHeight + spacing - 1);
            ctx.restore();
            // Hygene (blue)
            ctx.save();
            ctx.fillStyle = '#039be5';
            ctx.fillRect(
                this.x + iconSize + iconOffset,
                startY + 2 * (barHeight + spacing),
                (barWidth - iconSize - iconOffset) * (this.hygene / 100),
                barHeight
            );
            ctx.strokeStyle = '#01579b';
            ctx.strokeRect(this.x + iconSize + iconOffset, startY + 2 * (barHeight + spacing), barWidth - iconSize - iconOffset, barHeight);
            ctx.font = `bold ${iconSize}px sans-serif`;
            ctx.textBaseline = 'top';
            ctx.fillText('üßº', this.x, startY + 2 * (barHeight + spacing) - 1);
            ctx.restore();
        }
    }

    isPointInside(px, py) {
        // Simple bounding box hit test
        return px >= this.x && px <= this.x + this.size &&
               py >= this.y && py <= this.y + this.size;
    }

    moveRandomly(canvasWidth, canvasHeight) {
        // Move by a small random delta, but stay within canvas bounds
        const dx = Math.floor(Math.random() * 11) - 5; // -5 to +5
        const dy = Math.floor(Math.random() * 11) - 5; // -5 to +5
        this.x = Math.max(0, Math.min(canvasWidth - this.size, this.x + dx));
        this.y = Math.max(0, Math.min(canvasHeight - this.size, this.y + dy));
    }
}

let dinosaurs = [];

resizeCanvas();

let gameStarted = false;

function startGame() {
    if (gameStarted) return;
    gameStarted = true;
    document.getElementById('startGameBtn').style.display = 'none';
    // Place an initial egg at a random location
    placeRandomEgg();
    // Start egg scheduling
    scheduleNextEgg();
    // Start random movement
    enableRandomMovement();
}

document.getElementById('startGameBtn').addEventListener('click', startGame);


function drawHexagon(x, y, size, fillStyle, strokeStyle) {
    ctx.save();
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 3 * i + Math.PI / 6; // flat-topped orientation
        const px = x + size * Math.cos(angle);
        const py = y + size * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
    }
    ctx.closePath();
    ctx.fillStyle = fillStyle;
    ctx.fill();
    ctx.restore();
}

function drawHexGrid(size) {
    const horizSpacing = size * Math.sqrt(3); // width between centers
    const vertSpacing = size * 1.5;           // height between rows

    const cols = Math.ceil(canvas.width / horizSpacing) + 1;
    const rows = Math.ceil(canvas.height / vertSpacing) + 1;

    for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
            const x = col * horizSpacing + (row % 2) * (horizSpacing / 2);
            const y = row * vertSpacing;
            drawHexagon(x, y, size, "#b9f6ca", "#388e3c");
        }
    }
}

const hatchSound = new Audio('./sounds/egg_crack.mp3'); // Fun pop sound

function placeRandomEgg() {
    const minX = 200;
    const maxX = canvas.width - eggSize;
    const minY = 20;
    const maxY = canvas.height - eggSize;
    const x = Math.floor(Math.random() * (maxX - minX)) + minX;
    const y = Math.floor(Math.random() * (maxY - minY)) + minY;
    // Set hatch time between 3 and 6 seconds
    const hatchTime = 3000 + Math.random() * 3000;
    const egg = { x, y, hatching: true };
    eggs.push(egg);
    draw();
    setTimeout(() => {
        // When hatching, replace egg with a random dinosaur
        const idx = eggs.indexOf(egg);
        if (idx !== -1) {
            eggs.splice(idx, 1);
            // Play hatch sound
            hatchSound.currentTime = 0;
            hatchSound.play();
            // Random dino type: 0 or 1
            const type = Math.floor(Math.random() * dinoImages.length);
            const dino = new Dinosaur(x, y, dinoImages[type], type);
            dinosaurs.push(dino);
            draw();
        }
    }, hatchTime);
}

function scheduleNextEgg() {
    // Random delay: 20s to 40s
    const delay = 10000 + Math.random() * 10000;
    setTimeout(() => {
        placeRandomEgg();
        scheduleNextEgg();
    }, delay);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const hexSize = 45;
    drawHexGrid(hexSize);

    // Draw eggs
    for (const egg of eggs) {
        ctx.save();
        ctx.font = `${eggSize}px sans-serif`;
        ctx.textBaseline = 'top';
        ctx.fillText(eggIcon, egg.x, egg.y);
        ctx.restore();
    }

    // Draw dinosaurs
    for (const dino of dinosaurs) {
        ctx.save();
        dino.draw(ctx);
        ctx.restore();
    }
}

// Wait for both images to load before first draw
let imagesLoaded = 0;
dinosaurs.forEach(d => {
    d.img.onload = () => {
        imagesLoaded++;
        if (imagesLoaded === dinosaurs.length) {
            draw();
        }
    };
});

let points = 0;

function updatePointsDisplay() {
    let el = document.getElementById('pointsDisplay');
    if (!el) {
        el = document.createElement('div');
        el.id = 'pointsDisplay';
        el.style.position = 'fixed';
        el.style.top = '20px';
        el.style.right = '30px';
        el.style.background = '#fff8e1';
        el.style.color = '#6d4c41';
        el.style.fontSize = '1.5em';
        el.style.fontWeight = 'bold';
        el.style.padding = '10px 24px';
        el.style.borderRadius = '12px';
        el.style.boxShadow = '0 2px 8px #0002';
        el.style.zIndex = 100;
        document.body.appendChild(el);
    }
    el.textContent = `Puntos: ${points}`;
}

// Add drag-and-drop logic
let draggingStat = null;

document.addEventListener('DOMContentLoaded', () => {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggingStat = item.getAttribute('data-type');
            e.dataTransfer.setData('text/plain', draggingStat);
        });
        item.addEventListener('dragend', () => {
            draggingStat = null;
        });
    });
    updatePointsDisplay();
});

canvas.addEventListener('dragover', (e) => {
    if (draggingStat) {
        e.preventDefault();
    }
});
canvas.addEventListener('drop', (e) => {
    if (!draggingStat) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    for (const dino of dinosaurs) {
        if (dino.isPointInside(mx, my)) {
            let statReplenished = false;
            if (draggingStat === 'health' && dino.health < 100) {
                dino.health = 100;
                statReplenished = true;
            }
            if (draggingStat === 'hygene' && dino.hygene < 100) {
                dino.hygene = 100;
                statReplenished = true;
            }
            if (draggingStat === 'meat' && dino.type === 1 && dino.hunger < 100) {
                dino.hunger = 100;
                statReplenished = true;
            }
            if (draggingStat === 'veggie' && dino.type === 0 && dino.hunger < 100) {
                dino.hunger = 100;
                statReplenished = true;
            }
            if (statReplenished) {
                points++;
                updatePointsDisplay();
            }
            draw();
            break;
        }
    }
    draggingStat = null;
});

// Remove all drag and selection logic from event listeners
canvas.addEventListener('mousedown', (e) => {
    // Only select a dinosaur (optional: highlight on click)
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    let found = false;
    for (const dino of dinosaurs) {
        if (dino.isPointInside(mx, my)) {
            dinosaurs.forEach(d => d.selected = false);
            dino.selected = true;
            found = true;
            break;
        }
    }
    if (!found) {
        dinosaurs.forEach(d => d.selected = false);
    }
    draw();
});

// Remove mousemove and mouseup listeners

// Remove dragging variables
// let selectedDino = null;
// let offsetX = 0, offsetY = 0;
// let dragging = false;

// Add random movement interval
enableRandomMovement();
function enableRandomMovement() {
    setInterval(() => {
        for (const dino of dinosaurs) {
            // Only move if all stats are above zero
            if (dino.health > 0 && dino.hunger > 0 && dino.hygene > 0) {
                dino.moveRandomly(canvas.width, canvas.height);
            }
            // Randomly pick a stat to decrease: 0=health, 1=hunger, 2=hygene
            const stat = Math.floor(Math.random() * 3);
            const decrease = Math.random() * 1.0; // 0 to <1.0
            let statBefore, statAfter;
            if (stat === 0) {
                statBefore = dino.health;
                dino.health = Math.max(0, dino.health - decrease);
                statAfter = dino.health;
            } else if (stat === 1) {
                statBefore = dino.hunger;
                dino.hunger = Math.max(0, dino.hunger - decrease);
                statAfter = dino.hunger;
            } else {
                statBefore = dino.hygene;
                dino.hygene = Math.max(0, dino.hygene - decrease);
                statAfter = dino.hygene;
            }
            // Subtract a point if a stat just reached zero
            if (statBefore > 0 && statAfter === 0) {
                points = Math.max(0, points - 1);
                updatePointsDisplay();
            }
        }
        draw();
    }, 100);
}

// At the end of script, start egg scheduling
scheduleNextEgg();
</script>
</body>
</html>